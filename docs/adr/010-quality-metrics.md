# ADR-010: 品質計測方針

## ステータス
承認済み

## コンテキスト
サービス品質を継続的に監視・改善するため、パフォーマンス・可用性・リグレッションの計測方針を定義する。

## 決定

### 1. パフォーマンス計測

#### 1.1 リリース前検知（Lighthouse CI）

**目的:** リリース前にフロントエンドのパフォーマンス劣化を検知

| 項目 | 内容 |
|---|---|
| **コスト** | 無料（GitHub Actions内で実行） |
| **タイミング** | PR作成時、mainマージ時 |
| **計測指標** | LCP, FCP, CLS, TBT, Speed Index |
| **閾値** | LCP 2.5秒未満でCI失敗または警告 |
| **結果出力** | PRコメントに詳細レポート |

**計測フロー:**
```
GitHub Actions (PR/マージ時)
     ↓
  Next.js ビルド
     ↓
  ローカルサーバー起動 (next start)
     ↓
  Lighthouse CI 実行
     ↓
  結果をPRコメント出力 + 閾値チェック
```

#### 1.2 本番環境監視（Cloud Monitoring）

**目的:** 本番環境の継続的なパフォーマンス監視

| 項目 | 内容 |
|---|---|
| **対象** | Cloud Runのリクエストメトリクス |
| **可視化** | Cloud Monitoring ダッシュボード |
| **アラート** | 閾値超過時にCloud Consoleアプリに通知 |

**確認方法:**
1. GCPコンソール > Cloud Monitoring > ダッシュボード > 「SikouLab パフォーマンス」
2. 期間を選択してLCP、API応答時間のトレンドを確認

### 2. 可用性（SLA）計測

#### 2.1 Uptime Check

| 項目 | 設定値 |
|---|---|
| **チェック間隔** | 1分 |
| **タイムアウト** | 10秒 |
| **対象エンドポイント** | `https://<domain>/health` |
| **失敗判定** | 2回連続失敗でダウン扱い |

#### 2.2 アラート設定

詳細は [ADR-007: ログ監視](./007-log-monitoring.md) を参照。

### 3. リグレッション防止

#### 3.1 Jiraでの障害管理

| 項目 | 設定内容 |
|---|---|
| **課題タイプ** | 「障害」を使用 |
| **ラベル** | `market-defect`: 市場障害（リリース後発見）<br>`regression`: リグレッション<br>`rollback`: ロールバック実施 |
| **影響バージョン** | 該当リリースバージョンを記録 |

#### 3.2 Metabaseでの可視化

- Jira APIでチケットデータを取得
- リリースごとの市場障害数・ロールバック回数をダッシュボード化
- トレンドグラフで品質推移を監視

#### 3.3 障害対応フロー

```
1. 障害発見（ユーザー報告 or 運営者検知）
     ↓
2. Jiraに市場障害チケット作成
   - ラベル: market-defect, regression（該当する場合）
   - 影響バージョン: 該当リリースバージョン
   - 優先度: 影響度に応じて設定
     ↓
3. 対応（修正 or ロールバック）
   - ロールバックの場合、ラベル「rollback」を追加
     ↓
4. リリースレビューで振り返り
   - 根本原因の分析
   - 再発防止策の検討
```

**確認方法:**
1. Metabase > ダッシュボード > 「品質メトリクス」
2. リリースバージョンでフィルタして件数を確認

## 理由

- **リリース前検知**: 本番環境でのパフォーマンス劣化を未然に防ぐ
- **継続監視**: 実際のユーザートラフィックに基づくパフォーマンスを把握
- **リグレッションゼロ**: ユーザー体験への悪影響を最小化

## 影響

- GitHub ActionsにLighthouse CIのワークフロー追加
- Cloud Monitoringでダッシュボード・アラート設定
- Jiraで障害管理フロー構築
- Metabaseで品質ダッシュボード作成

## 関連ドキュメント

- [docs/service.md](../service.md) - サービス定義書（品質目標）
- [ADR-007: ログ監視](./007-log-monitoring.md) - 監視・アラート設定
