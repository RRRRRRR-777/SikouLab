# ADR-015: インフラ環境構築

## ステータス
承認済み

## コンテキスト

本番環境のコンテナ実行基盤として、Cloud Run と GKE のどちらを採用するか決定が必要。
開発ガイドラインでは「Cloud Run vs GKE（費用対効果計算後に決定）」として保留されていた。

インフラ設計書（§1.3 想定スケール）に記載している各指標（登録ユーザー数・同時ユーザー数・日次リクエスト数）の算出根拠が文書化されていなかった。設計値が直感値か計算値かを区別するため、前提と計算過程を記録する。

なお、ピーク係数（瞬間最大倍率）はサービスの性質・時間帯・イベントによって大きく変動し、運用前に絶対値として定義することは困難である。そのためスケール指標は **平均値** で管理し、瞬間ピークへの対応は Cloud Run のオートスケーリングに委ねる方針とする。

### 前提条件
- **想定規模**: 初期1,200人（アクティブ800人）、3年後2,400人
- **ユーザー特性**: ROM専98.5%（閲覧中心、書き込み少ない）
- **SLA目標**: 99.5%（ADR-010）
- **運用体制**: 一人運用
- **デプロイ対象**: フロントエンド（Next.js）+ バックエンド（Go API）の2サービス
- **デプロイフロー**: GitHub Environment承認（ADR-006）

### スケール設計の前提

#### ユーザー数の前提

| 指標 | 値 | 根拠 |
|------|-----|------|
| 登録ユーザー数 | 1,200人 | サービス定義書の目標値（招待制クローズドβ → 一般公開の積み上げ） |
| DAU（日次アクティブ） | 800人 | 登録ユーザーの約67%がDAUと仮定。ROM専サービスとしては高めの想定 |
| ユーザー特性 | ROM専98.5% | 投稿・コメント機能を持たない設計。閲覧のみが大半 |

#### 平均同時ユーザー数の計算

```
平均同時ユーザー数 = DAU × 1日あたりセッション時間(分) ÷ アクティブ時間帯(分)
                   = 800 × 98分 ÷ 960分（16時間）
                   ≈ 82人
```

**1日あたりセッション時間の内訳:**

| 区分 | 時間 | 内訳 |
|------|------|------|
| アクティブ閲覧（記事） | 38分 | 1日15記事 × 読了時間2.5分（2〜3分の中央値） |
| その他機能（ニュース・ポートフォリオ・アンケート） | 30分 | 概算 |
| アイドル（タブ放置、ポーリング継続） | 30分 | 概算 |
| **合計** | **98分（≈1.6時間）** | |

- アイドル時間中もクライアントは1分間隔でポーリングリクエストを送信するため、インフラ負荷の計算に含める
- サーバー側データ（ニュース・株価）はバッチ取得だが、ユーザーに最新状態を反映するために高頻度ポーリングを採用

**計算の前提:**
- 起床時間を 06:00〜22:00 の16時間と仮定
- DAUがその時間帯に均等分散するとして平均値を算出
- これは **平均値** であり、ピーク値ではない

**ピーク係数について:**
- ピーク係数（瞬間最大 / 平均）はサービス種別・時間帯・イベント等に依存し、事前に絶対値で定義することは困難
- 一般的なメディア系サービスの目安は 2〜4倍（＝ピーク時 ~165〜330人）だが、実測なしに断定しない
- 瞬間ピークへの対応は Cloud Run のオートスケーリング（max-instances=3）に委ねる

**妥当性チェック:**
- 平均82人に対して concurrency=80〜100 / FE min-instances=1 / BE min-instances=0 / max-instances=3 で対応可能
- 平均負荷は1インスタンスのconcurrency上限付近だが、ピーク時はオートスケーリングで2〜3インスタンスに拡張される
- 3年後スケール（DAU 1,600人）でも同比率で平均~165人。max-instances を必要に応じ引き上げる

#### 日次リクエスト数の計算

```
操作起点リクエスト: 63リクエスト/DAU
ポーリングリクエスト: 98リクエスト/DAU
合計: 161リクエスト × 800 DAU ≈ 129,000リクエスト/日
```

**操作起点リクエストの内訳（1セッションあたり）:**
| アクション | ページロード数 | APIリクエスト/ページ | 小計 |
|-----------|--------------|-------------------|------|
| ダッシュボード閲覧 | 1 | 5 | 5 |
| 記事一覧・詳細閲覧 | 3 | 4 | 12 |
| ニュース閲覧 | 2 | 3 | 6 |
| 銘柄・アンケート閲覧 | 2 | 3 | 6 |
| SSRページ生成リクエスト | 8 | - | 8 |
| 静的アセット（GCS直接配信） | - | - | 除外 |
| **1セッション合計** | | | **~37** |

- 1日あたりセッション数を平均1.7回と仮定（ROM専ユーザーの閲覧行動）
- 37 × 1.7 ≈ 63リクエスト/DAU

**ポーリングリクエスト:**
- 1日あたりセッション時間 98分 × 1リクエスト/分 = 98リクエスト/DAU
- アクティブ時間・アイドル時間ともに1分間隔でポーリング

## 決定

**Cloud Run** を採用する。フロントエンド・バックエンド両方を Cloud Run にデプロイする。

### 構成

| サービス | 実行基盤 | 備考 |
|---------|---------|------|
| Next.js（SSR） | Cloud Run | standalone output mode |
| Go API | Cloud Run | コンテナイメージ |
| PostgreSQL | Cloud SQL | マネージドDB |
| 静的アセット | Cloud Storage（公開バケット直接配信） | 画像配信。CDNは初期不要 |

### コールドスタート対策

| 設定 | 値 | 理由 |
|------|-----|------|
| min-instances（FE） | 1 | Next.js起動1-3秒のため常時待機が必要 |
| min-instances（BE） | 0 | Goの起動は100ms以下。コスト削減優先 |
| Startup CPU Boost（FE） | 無効 | min=1で起動が稀なため効果なし |
| Startup CPU Boost（BE） | 有効 | min=0のコールドスタート時に起動速度を向上 |

### エッジ構成の最適化

初期規模に対してエッジ層（LB / CDN / WAF）の構成を最適化する。

#### Cloud Load Balancing: 最小構成で採用

| 項目 | 決定 | 理由 |
|------|------|------|
| Cloud Load Balancing | **採用** | カスタムドメイン（HTTPS + SSL証明書）に必須。URL Map による FE/BE のルーティングも担う |

- カスタムドメインはユーザー公開サービスとして必要（`*.run.app` ドメインではブランディング・信頼性に問題）
- 構成はURL Map + Serverless NEG + Google Managed SSL の最小構成とし、CDNは含めない

#### Cloud CDN: 初期不採用

| 項目 | 決定 | 理由 |
|------|------|------|
| Cloud CDN | **不採用（初期）** | 国内ユーザー × 同時75人の規模ではCDNキャッシュの効果が薄い |

**根拠**:
- Cloud Storage バケットが `asia-northeast1`（東京）にあり、国内ユーザーへの直接配信レイテンシは20-40msで十分
- 同時75ユーザーの規模ではCDNキャッシュヒット率が低く、費用対効果が合わない
- 画像はCloud Storageの公開バケットから直接配信する
- トラフィック増加や海外展開時にCloud CDNを有効化する（LBのBackend Bucketに追加するだけ）

#### Cloud Armor: 採用

| 項目 | 決定 | 理由 |
|------|------|------|
| Cloud Armor | **採用** | $5/月 + 構築1-2hで、DDoS耐性・地域制限・WAFの防御層を追加できる |

**根拠**:
- アプリ層の対策（sqlc、React、CSP）は根本的な防御だが、Cloud Armorはその前段でトラフィックをフィルタリングする補助防御として有効
- DDoS攻撃時にmax-instances=3が埋まると正規ユーザーもアクセス不可になる。Cloud ArmorはLB層で不正トラフィックを吸収し、正規ユーザーへの影響を軽減する
- 地域制限（日本のみ）は海外からの不正アクセスに対する唯一の防御手段であり、アプリ層では代替できない
- 攻撃検知後にCloud Armorを追加する場合、設定に1-2時間かかりその間は無防備になる。事前導入で空白期間をなくす
- LB導入済みのため、Backend Serviceにポリシーを紐付けるだけで有効化できる

### リソース最適化

初期規模（同時75ユーザー、DAU 800人）に対してリソース設定がオーバースペックにならないよう最適化する。

#### min-instances: BEのみmin=0に設定

| サービス | 設定 | 理由 |
|---------|------|------|
| FE（Next.js） | min=1 | Node.jsの起動は1-3秒かかり、ユーザー体験に直結する。常時待機が必要 |
| BE（Go API） | min=0 | Goバイナリの起動は100ms以下。コールドスタートの影響が極めて小さい |

**根拠**:
- Goの起動速度は100ms以下であり、Startup CPU Boostと組み合わせればさらに短縮される。ユーザーが体感するレイテンシ増加はAPIレスポンス全体（DB通信含む）に対して無視できる水準
- FE → BE間はサーバーサイド通信であり、ブラウザの直接待ち時間にならない。FEが常時起動していればBEのコールドスタートはFEのSSR処理中に吸収される
- min=1の常時待機コストは月額$5-10程度。初期の限られた予算では削減効果が大きい

**Startup CPU Boostとの連携**:
- BE（min=0）: Startup CPU Boost **有効**。コールドスタート時の起動速度を向上させる
- FE（min=1）: Startup CPU Boost **無効**。常時1インスタンスが待機しており、起動が発生する頻度が極めて低いため効果がない

#### concurrency: FE=80 / BE=100

| サービス | 設定 | 理由 |
|---------|------|------|
| FE（Next.js） | 80 | Cloud Runのデフォルト値。Node.jsはシングルスレッドのため過度に高くしない |
| BE（Go API） | 100 | Goroutineによる並行処理が得意なため、デフォルト（80）より高く設定 |

#### max-instances: 3

平均同時82ユーザー、concurrency=80-100の設定で1インスタンスで処理可能。ピーク時（2-4倍）は最大3インスタンスでカバーする。

#### ポイントインタイムリカバリ（PITR）: 有効のまま維持

| 項目 | 決定 | 理由 |
|------|------|------|
| PITR | **有効（維持）** | データ損失リスクに対する保険として不可欠 |

**根拠**:
- 投稿者数は少ない（初期2-3人）が、1日分の記事執筆は著者にとって大きな時間的投資である。日次バックアップでは最大24時間分の執筆内容が失われる可能性がある
- **データ損失は開発者が担保できるものではない**。技術的な最適化でデータの安全性を犠牲にすべきではない
- PITRの追加コスト（トランザクションログのストレージ）はdb-f1-microの10GB SSDに対してごくわずか

## 検討した選択肢

### 比較表

| 評価軸 | Cloud Run | GKE Autopilot | GKE Standard |
|--------|-----------|--------------|--------------|
| 月額コスト（この規模） | ◎ $32-58 | △ $100-150 | × $150-200 |
| 構築工数 | ◎ 40-60h | ○ 60-80h | △ 84-114h |
| 運用複雑度 | ◎ 低い | ○ 中程度 | △ 高い |
| スケーラビリティ | ○ 十分 | ◎ 柔軟 | ◎ 最も柔軟 |
| 一人運用適合性 | ◎ 最適 | ○ 許容 | △ 負荷が高い |
| 将来のマイクロサービス化 | △ サービス増で管理複雑化 | ◎ Namespace分離 | ◎ 最も柔軟 |

### 詳細評価

#### Cloud Run
- メリット: 最小コスト、スケールto0可能、Cloud Load Balancingとの統合が容易、デプロイが簡単（`gcloud run deploy`）、K8sの知識不要
- デメリット: リクエストタイムアウト60分上限、サービス間通信にService Mesh不可、CronJobはCloud Schedulerで別管理

#### GKE Autopilot
- メリット: ノード管理不要、Pod単位課金、K8sエコシステム利用可能
- デメリット: 最低料金がCloud Runより高い、K8s知識が必要

#### GKE Standard
- メリット: 最も柔軟、ノード/Pod完全制御、複雑なワークロード対応
- デメリット: ノード常時課金、運用負荷が高い、この規模ではオーバースペック

## 理由

### Cloud Runが採用された理由
1. **コスト最適**: 800アクティブユーザーの規模では、GKEの1/3〜1/5のコストで運用可能
2. **運用負荷最小**: K8sクラスタ管理、ノード管理、Ingress設定等が不要。一人運用に最適
3. **十分なスケーラビリティ**: 2,400人規模でもCloud Runの上限（最大1000インスタンス）に対して余裕がある
4. **GCP完結**: Cloud SQL、Cloud CDN、Cloud Logging等とのネイティブ統合でインフラ全体がシンプル
5. **将来の移行容易性**: コンテナイメージベースのため、将来GKEへの移行が必要になった場合もDockerfileはそのまま利用可能

### スケール設計の根拠
- 精緻な実測値がない初期段階では、利用行動パターンの仮定から逆算するアプローチが妥当
- ROM専98.5%という特性上、書き込み系APIは全体の1.5%未満。読み取り負荷が支配的
- 初期スケールは保守的に見積もり、Cloud Runのオートスケーリングで実態に追従させる方針

### GKEが必要になるタイミング（参考）
- DAU 10,000以上で常時高トラフィックが続く場合
- マイクロサービスが5つ以上に増え、サービス間通信が複雑化した場合
- バッチ処理がCronJob多数（10以上）で Cloud Scheduler では管理困難な場合

## 月額コスト試算

### Cloud Run 構成

| 項目 | 月額（USD） | 備考 |
|------|-----------|------|
| Cloud Run（Next.js） | $10-20 | 0.5 vCPU, 512MB, min=1 |
| Cloud Run（Go API） | $5-15 | 0.5 vCPU, 256MB, min=0 |
| Cloud Load Balancing | $18-20 | 転送ルール1つ（カスタムドメイン用） |
| Cloud Armor | $5 | WAFポリシー1つ |
| Cloud SQL（PostgreSQL） | $10 | db-f1-micro |
| Cloud Storage | $1-3 | 画像・VRTベースライン（CDN不使用） |
| Cloud Logging | $0-2 | 7日保持 |
| Cloud Monitoring | $0 | 基本無料 |
| Egress | $5-15 | Cloud Run・Cloud Storage → クライアント（$0.085/GB、同一リージョン内は無料） |
| **合計** | **$54-91/月** | |

> LB（カスタムドメイン必須）とCloud Armor（DDoS・WAF対策）を含み、CDNを除外。BE min=0でコスト削減。

### 参考: GKE Standard の場合

| 項目 | 月額（USD） |
|------|-----------|
| GKEクラスタ管理費 | ~$74 |
| ノード（e2-small x 2） | ~$50 |
| Cloud SQL | ~$10 |
| ロードバランサ | ~$18 |
| その他 | ~$5-10 |
| **合計** | **$150-200/月** |

## 前提の見直しトリガー

以下の条件が発生した場合、本ADRを更新してスケール設計を見直す。

| トリガー | 対応 |
|---------|------|
| Cloud Monitoring で平均同時ユーザー数が想定値（~82）を20%以上上回る | max-instances を引き上げ、次バージョンのスケール前提を更新 |
| DAUが想定を20%以上上回る or 下回る | 本ADRのユーザー数前提を実測値で上書き |
| ユーザー特性が変化（投稿機能追加等） | ROM専比率・リクエスト数内訳を再計算 |
| BEのコールドスタートによるレイテンシがp95で500msを超える | BE min-instances=1に変更 |
| PITRのストレージコストがdb-f1-microの上限に迫る | ストレージ自動増加設定の確認、またはマシンタイプのスケールアップ |

## 影響
- **ADR-006（デプロイフロー）**: ロールバック手順を「Cloud Run リビジョン切り替え」に確定
- **開発ガイドライン**: デプロイ先の「Cloud Run vs GKE（費用対効果計算後に決定）」を「Cloud Run」に更新
- **CI/CD**: `gcloud run deploy` ベースのデプロイワークフローを構築
- **Dockerfile**: FE/BE 両方のDockerfile作成が必要
- **バッチ処理**: ニュース取得（F-05-1）、予約投稿（F-04-2）等のCronJobは Cloud Scheduler + Cloud Run Jobs で実装
- **infrastructure.md §1.1**: 構成図にLB最小構成 + Cloud Armorを反映（CDNなし）
- **infrastructure.md §1.3**: 本ADRを根拠として参照
- **infrastructure.md §2.2**: FE min=1 / BE min=0、Startup CPU BoostはBEのみ有効
- **infrastructure.md §3.3**: PITR有効維持
- **infrastructure.md §4**: Cloud Storage公開バケット直接配信（CDNなし）
- **infrastructure.md §5.2**: LB最小構成（URL Map + Serverless NEG、CDN無効、Armor有効）
- **infrastructure.md §5.6**: Cloud Armorポリシー（レート制限、地域制限、OWASP CRS）
- **infrastructure.md §9.1**: 月額コスト $49-76/月

## 参考情報
- [Cloud Run 公式ドキュメント](https://cloud.google.com/run/docs)
- [Cloud Run vs GKE 比較](https://cloud.google.com/blog/products/serverless/when-to-use-google-cloud-run-vs-gke)
- [Cloud Run 料金](https://cloud.google.com/run/pricing)
- [インフラ設計書 §1.3 想定スケール](../versions/1_0_0/infrastructure.md)
- [ADR-010: 品質計測方針](./010-quality-metrics.md)
