# ADR-014: 検索エンジン方式の選定

## ステータス
承認済み

## コンテキスト
検索機能（F-07）において、記事・ニュース・銘柄・アンケートの横断検索を実装する必要がある。以下の要件・制約を考慮して検索エンジン方式を選定する。

- **検索対象**: 日本語コンテンツが中心（記事タイトル/本文、ニュースタイトル/本文/翻訳、銘柄コード/名、アンケートタイトル）
- **インフラ**: PostgreSQLは自前で構築する想定
- **プロダクト原則**: 「作りすぎない」— 初期は最小限、将来拡張を壊さない設計
- **検索の位置づけ**: 受動的体験が最優先のプロダクトにおける補助的な能動機能
- **「全て」タブ**: 4種類のコンテンツを混合表示するため、スコアリングがあると結果品質が向上する

## 決定
**PGroonga（PostgreSQL拡張）** を採用する。

### 詳細構成

| 用途 | 技術 | 備考 |
|------|------|------|
| 全文検索エンジン | PGroonga | PostgreSQL拡張モジュール |
| 形態素解析 | MeCab + IPA辞書 | 日本語トークナイズ |
| インフラ管理 | Docker | Groonga + MeCab + 辞書をDockerfileで管理 |

## 検討した選択肢

### 比較表

| 選択肢 | 日本語精度 | 導入コスト | 運用コスト | ランキング | インフラ追加 |
|--------|:---:|:---:|:---:|:---:|:---:|
| ~~LIKE/ILIKE~~ | △ | ◎ | ◎ | × | なし |
| ~~PG標準全文検索~~ | × | ○ | ◎ | ○ | なし |
| pg_bigm | ○ | ○ | ◎ | × | なし |
| **PGroonga** | ◎ | ○ | ◎ | ○ | なし |
| Typesense | ○ | △ | △ | ◎ | あり |
| Elasticsearch | ◎ | × | × | ◎ | あり |

### 早期除外した選択肢

#### LIKE/ILIKE
- メリット: 最もシンプル。追加拡張不要
- 懸念点: データ量増加で性能劣化。日本語検索精度に限界。ランキング機能なし
- **除外理由**: 日本語検索の精度・性能が不十分

#### PostgreSQL標準全文検索（tsvector/tsquery）
- メリット: PG標準機能。英語は高精度
- 懸念点: 日本語トークナイズ非対応
- **除外理由**: 日本語非対応

### 詳細評価した選択肢

#### pg_bigm
- メリット: PG拡張1つで導入可能。LIKE文がそのまま使え学習コスト最小
- 懸念点:
  - bi-gramのノイズ（「京都」→「東京都」ヒット）
  - ランキング機能なし
  - 2文字未満の検索精度が低い
  - pg_bigmで始めて後からPGroongaへ移行する案も検討したが、移行コスト（クエリ書き換え + インデックス再構築 + テスト）を考慮し最初からPGroongaが合理的と判断

#### PGroonga
- メリット: MeCab形態素解析で日本語高精度。スコアリング対応。PG内完結。トランザクション整合性
- 懸念点:
  - PGメジャーアップグレード時の互換性待ちの可能性
  - Groonga + MeCab + 辞書の管理が必要
  - 専用演算子の学習が必要。将来マネージドDB移行時はクエリ書き換え
  - インデックスサイズが元データの1〜2倍
- 懸念の評価: 自前PG方針のためマネージドDB問題は当面該当しない。Dockerで管理可能

#### Typesense
- メリット: 軽量・超高速。タイポ補正・サジェスト標準搭載。マネージドCloud有
- 懸念点:
  - DB同期の仕組みが必要（実装量増加）
  - 別サービス追加で障害点が増加
  - 同期遅延によるデータ不整合の可能性
  - コスト増（Cloud: 月$30〜）
  - 検索UXの高度化は「受動的体験が最優先」のプロダクトではリターンが限定的

#### Elasticsearch
- メリット: 業界標準。kuromojiで日本語対応。最も高機能
- 懸念点:
  - JVMベースでメモリ2-4GB推奨。リソース消費が過大
  - 運用負荷が大きい（クラスタ管理、シャード設計）
  - コストが高い（Elastic Cloud月$95〜）
  - DB同期にLogstash/Debezium等のパイプラインが必要
  - v7.11以降SSPLライセンス
  - ver1.0.0にはオーバーエンジニアリング

## 理由

### PGroongaが採用された理由
1. **PG内完結**: 新しいサービスを追加せずPostgreSQL内で完結する。「作りすぎない」原則に合致し、DB同期の仕組みやエラーハンドリングが不要
2. **日本語検索精度**: 記事・ニュースは日本語コンテンツが中心。MeCab形態素解析により、bi-gramのノイズ問題（「京都」→「東京都」ヒット）を回避できる
3. **スコアリング**: 「全て」タブで4種類のコンテンツを混合表示する際、スコアリングによる結果品質の向上が見込める
4. **データ整合性**: PostgreSQLのトランザクションと完全に一致するため、同期遅延や不整合の懸念がない
5. **初期導入コスト vs 移行コスト**: pg_bigmで始めて後から移行する案も検討したが、クエリ書き換え + インデックス再構築 + テストの移行コストを考慮すると、最初からPGroongaにする方が合理的

### 懸念点と対策

| 懸念 | 対策 |
|------|------|
| PGメジャーアップグレード時の互換性 | PGroongaの追従は比較的早い。アップグレード前に互換性を確認する運用を設ける |
| Groonga + MeCab + 辞書の管理 | Dockerfileで一元管理し、再現可能なセットアップを維持 |
| 将来のマネージドDB移行 | 現時点で自前PGの方針。移行が必要になった時点で再検討（ADR更新） |
| PGroonga専用演算子の学習 | ドキュメントが日本語で充実しており、学習コストは限定的 |

## 影響
- **F-07（検索機能）**: PGroongaベースで検索API・インデックスを実装
- **インフラ**: DockerfileにGroonga + MeCab + IPA辞書のインストールを追加
- **検索対象テーブル**: articles, news, news_translations, stocks, pollsにPGroongaインデックスを作成

## 参考情報
- [PGroonga](https://pgroonga.github.io/ja/)
- [pg_bigm](https://pg-bigm.github.io/pg_bigm_en/)
- [Typesense](https://typesense.org/)
- [Elasticsearch](https://www.elastic.co/elasticsearch)
