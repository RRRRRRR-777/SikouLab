# ADR-007: ログ監視方式の選定

## ステータス
承認済み

## コンテキスト
本番環境の障害を早期検知するため、ログ監視・アラート通知の仕組みが必要。
以下の要件を満たす方式を選定する。

- **最優先目的**: 障害の早期検知
- **監視対象**: バックエンド（Go）+ インフラ（Cloud Run/GKE）
- **運用体制**: 一人運用
- **検知したいもの**: 500エラー、サービスダウン、外部API通信失敗

## 決定
- **ログ収集**: Cloud Logging（GCPネイティブ）
- **監視・アラート**: Cloud Monitoring
- **通知先**: Cloud Consoleアプリ（iOSプッシュ通知）
- **ログ保持期間**: 7日程度

## 検討した選択肢

| 選択肢 | 初期構築コスト | 月額コスト | アラート即時性 | 運用負荷 | 拡張性 |
|--------|---------------|-----------|---------------|---------|--------|
| **A: GCP完結** | ◎ 低い | ◎ 無料〜数百円 | ○ 数分遅延あり | ○ 中程度 | △ 限定的 |
| B: Logging + Datadog | ○ 中程度 | △ $15〜/月 | ◎ リアルタイム | ◎ 低い | ○ 良好 |
| C: Datadog統合 | △ やや高い | × $23〜/月 | ◎ リアルタイム | ◎ 低い | ◎ 高い |

## 理由
1. **コスト最小化**: 初期フェーズで追加コストを抑えられる
2. **GCP完結**: インフラがGoogle Cloudのため、追加設定が最小限
3. **一人運用に適合**: PagerDuty等の高度なオンコール管理は不要
4. **段階的拡張可能**: 運用が軌道に乗ったらDatadog等への移行も可能

## 障害発生時のフロー

```
1. 障害発生
   │  例: 外部API通信失敗、500エラー
   ↓
2. Cloud Loggingにログ出力
   │  Goアプリからstructured log出力
   ↓
3. ログベースメトリクスが条件検知
   │  例: severity=ERROR が5分間で10件以上
   ↓
4. Cloud Monitoringがアラート発火
   ↓
5. Cloud Consoleアプリにプッシュ通知
   │  スマホに即時通知
   ↓
6. アプリで詳細確認
   │  - どのサービスか
   │  - エラー内容
   │  - ログ詳細
   ↓
7. 対応
   ├─ 軽微 → 後で対応
   └─ 重大 → Cloud Shell or PCで対応
```

## 通知先の詳細

### Cloud Consoleアプリ（iOS）
- **App Store**: [Google Cloud](https://apps.apple.com/jp/app/google-cloud/id1005120814)
- **対応OS**: iOS 17.0以上
- **機能**: プッシュ通知、ダッシュボード、ログ確認、Cloud Shell

### 通知で届く情報
- アラート名（例: 「外部API通信エラー」）
- 発生時刻
- 該当プロジェクト・サービス
- メトリクスの閾値超過状況

## WANT: LLM分析機能（将来拡張）

障害発生時にLLMがログを分析し、所感・推奨対応を自動生成する機能。

### 構成案
```
アラート発火
    ↓
  Pub/Sub
    ↓
Cloud Functions
    ├─ ログ取得（Cloud Logging API）
    ├─ Vertex AI (Gemini) で分析
    │   └─ 「何が起きたか」「推奨対応」を生成
    ↓
Jiraにインシデントチケット自動作成
    └─ LLM分析結果を含む
```

### 期待される効果
- 障害の初期分析を自動化
- 対応方針の判断を迅速化
- インシデント履歴の蓄積

## 影響
- Cloud Loggingの設定（ログルーター、保持期間）
- Cloud Monitoringのアラートポリシー作成
- ログベースメトリクスの定義
- Cloud Consoleアプリのインストール・通知設定
