---
paths:
  - "backend/**/*"
---

# backendディレクトリルール

## データ設計原則
* **ER図を単一の正とする** - コードはER図に従う
* **先にDBに保存 → 表示・加工** の順序を守る
* **削除より「状態管理」を優先** - 論理削除を基本とする

## 認証・認可
* **OAuth のみ** - Google / Apple 等
* **Stripe Customer ID を正とする** - 課金状態の判定
* **決済失敗時は即時権限制限**
* ロール × プランで最終権限を決定
  * ロール: admin / writer / user
  * プラン: ベースプラン / 上位プラン

## API設計
* RESTful原則に従う
* 認証が必要なエンドポイントは必ずトークン検証
* レスポンスは一貫した形式（成功/エラー）
* バリデーションは境界（ユーザー入力、外部API）でのみ

## データ更新戦略
* **ニュース・株価系データはバッチ中心**
* 30秒〜2分以内更新は将来検討（現時点では不要）
* リアルタイム性よりデータ整合性を優先

## セキュリティ
* SQL Injection対策 - ORMを使用し、生SQLは避ける
* Command Injection対策 - 外部コマンド実行は最小限に
* OWASP Top 10を常に意識
* シークレット管理は環境変数で（コードに含めない）

## 実装時の注意
* 過度な抽象化を避ける - YAGNIの原則
* 使われていないコードは完全削除
* 将来の拡張を「壊さない」設計（ただし先回りして実装しない）

## Go コーディング必須ルール

### エラーハンドリング
* エラーは明示的に返し、必ずチェックする
* `fmt.Errorf("context: %w", err)` でコンテキストを付与してラップ
* sentinel errors (`var ErrNotFound = errors.New(...)`) を定義して使用

### 設計原則
* インターフェースを受け取り、具体型を返す
* 短いスコープでは短い変数名（`u` for user）
* パッケージ名は単数形・小文字（`user` not `users`）

### 必須ツール
* `gofmt -w .` - フォーマット
* `goimports -w .` - import整理
* `golangci-lint run` - 静的解析

### テスト
* table-driven tests を基本とする
* カバレッジ80%以上を目標

### 詳細リファレンス
パターンやコード例の詳細が必要な場合は `/go-standards` スキルを呼び出してください。
